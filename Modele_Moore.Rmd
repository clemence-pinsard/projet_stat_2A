---
title: "Modele_Moore"
output: html_document
date: "2026-01-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Précuations initiales

On commence par executer Code_propre.Rmd pour avoir les bonnes données. Puis on importe les librairies necessaires.

```{r}
library(dplyr)
library(nlme)
library(tibble)
library(stringr)
library(purrr)
```

## Nettoyage et préparation générale

```{r}
df_model <- df_final %>%
  filter(
    !is.na(mark_numeric_corrigee),
    !is.na(Age),
    !is.na(discipline),
    !is.na(ID),
    !is.na(Sex)
  ) %>%
  droplevels()
```

On crée t (le temps dans notre modèle).

```{r}
t0 <- min(df_model$Age, na.rm = TRUE)
df_model <- df_model %>%
  mutate(
    t = Age - t0,
    disc_factor = factor(discipline),
    sex_factor = factor(Sex),
    disc_sex = interaction(discipline, Sex)
  )
```

## Fonction pour filtrer et préparer les données

```{r}
prepare_data <- function(data, group_var, min_obs = 50, percentile = 0.995){
  data %>%
    group_by(across(all_of(group_var))) %>%
    filter(n() >= min_obs) %>%
    ungroup() %>%
    droplevels() %>%
    filter(mark_numeric_corrigee <= quantile(mark_numeric_corrigee, percentile))}
```

## Fonction pour le calcul des valeurs initiales

```{r}
compute_start <- function(data, group_var){
  data %>%
    group_by(across(all_of(group_var))) %>%
    summarise(
      a = max(mark_numeric_corrigee, na.rm = TRUE),
      b = 0.01,
      c = min(mark_numeric_corrigee, na.rm = TRUE),
      d = 0.005
    ) %>% ungroup()
}
```

# Modèle de Moore par discipline

```{r}
df_disc <- prepare_data(df_model, "disc_factor", min_obs = 100)
start_disc <- compute_start(df_disc, "disc_factor")

modele_disc <- nlme(
  mark_numeric_corrigee ~ a * (1 - exp(-0.01 * t)) + c * (1 - exp(0.005 * t)),
  data = df_disc,
  fixed = a + c ~ disc_factor,
  random = a ~ 1 | ID,
  start = c(a = start_disc$a, c = start_disc$c),
  control = nlmeControl(maxIter = 2000, pnlsMaxIter = 200, tolerance = 1e-5, msVerbose = TRUE)
)

summary(modele_disc)
fixef(modele_disc)
```

# Modèle de Moore par sexe

```{r}
df_sex <- prepare_data(df_model, "sex_factor", min_obs = 50)
start_sex <- compute_start(df_sex, "sex_factor")

modele_sex <- nlme(
  mark_numeric_corrigee ~ a * (1 - exp(-0.01 * t)) + c * (1 - exp(0.005 * t)),
  data = df_sex,
  fixed = a + c ~ sex_factor,
  random = a ~ 1 | ID,
  start = c(a = start_sex$a, c = start_sex$c),
  control = nlmeControl(maxIter = 2000, pnlsMaxIter = 200, tolerance = 1e-5, msVerbose = TRUE)
)

summary(modele_sex)
fixef(modele_sex)
```

# Modèle de Moore par athlète x discipline

```{r}
# Ici, on s'assure que chaque athlète a assez d'observations dans la discipline
df_ath_disc <- df_model %>%
  group_by(ID, disc_factor) %>%
  filter(n() >= 5) %>%
  ungroup() %>%
  droplevels()

df_ath_disc <- prepare_data(df_ath_disc, "disc_factor", min_obs = 50)
start_ath_disc <- compute_start(df_ath_disc, "disc_factor")

modele_ath_disc <- nlme(
  mark_numeric_corrigee ~ a * (1 - exp(-0.01 * t)) + c * (1 - exp(0.005 * t)),
  data = df_ath_disc,
  fixed = a + c ~ disc_factor,
  random = a ~ 1 | ID/disc_factor,
  start = c(a = start_ath_disc$a, c = start_ath_disc$c),
  control = nlmeControl(maxIter = 2000, pnlsMaxIter = 200, tolerance = 1e-5, msVerbose = TRUE)
)

summary(modele_ath_disc)
fixef(modele_ath_disc)
```

# Calcul de l'âge au pic dans chaque cas 

## Modèle par discipline

```{r}
# Extraire les coefficients fixes
params_disc <- as.data.frame(coef(modele_disc))
params_disc$discipline <- rownames(params_disc)
rownames(params_disc) <- NULL

a_cols <- grep("^a", names(params_disc), value = TRUE)
c_cols <- grep("^c", names(params_disc), value = TRUE)

# extraire juste le nom de la discipline après "a.disc_factor"
params_disc$discipline <- str_replace(params_disc$discipline, "^a\\.disc_factor", "")
params_disc$discipline <- str_trim(params_disc$discipline)  # enlever espaces


params_disc <- params_disc %>%
  rowwise() %>%
  mutate(
    t_pic = log((get(a_cols[1]) * 0.01) / (get(c_cols[1]) * 0.005)) / (0.01 + 0.005),
    Age_pic = t_pic + t0
  )

params_disc
```

## Modèle par sexe

```{r}
# Extraire les coefficients fixes
params_sexe <- as.data.frame(coef(modele_sex))
params_sexe$discipline <- rownames(params_sexe)
rownames(params_sexe) <- NULL

a_cols_sexe <- grep("^a", names(params_sexe), value = TRUE)
c_cols_sexe <- grep("^c", names(params_sexe), value = TRUE)

# extraire juste le nom de la discipline après "a.disc_factor"
params_sexe$discipline <- str_replace(params_sexe$discipline, "^a\\.disc_factor", "")
params_sexe$discipline <- str_trim(params_sexe$discipline)  # enlever espaces


params_sexe <- params_sexe %>%
  rowwise() %>%
  mutate(
    t_pic = log((get(a_cols_sexe[1]) * 0.01) / (get(c_cols_sexe[1]) * 0.005)) / (0.01 + 0.005),
    Age_pic = t_pic + t0
  )

params_sexe
```

## Modèle par athlète x discipline

```{r}
## Extraire les coefficients fixes
params_ath_disc <- as.data.frame(coef(modele_ath_disc))
params_ath_disc$discipline <- rownames(params_ath_disc)
rownames(params_ath_disc) <- NULL

a_cols_ath_disc <- grep("^a", names(params_ath_disc), value = TRUE)
c_cols_ath_disc <- grep("^c", names(params_ath_disc), value = TRUE)

# extraire juste le nom de la discipline après "a.disc_factor"
params_ath_disc$discipline <- str_replace(params_ath_disc$discipline, "^a\\.disc_factor", "")
params_ath_disc$discipline <- str_trim(params_ath_disc$discipline)  # enlever espaces


params_ath_disc <- params_ath_disc %>%
  rowwise() %>%
  mutate(
    t_pic = log((get(a_cols_ath_disc[1]) * 0.01) / (get(c_cols_ath_disc[1]) * 0.005)) / (0.01 + 0.005),
    Age_pic = t_pic + t0
  )

params_ath_disc
```

```{r}
compute_age_pic <- function(a, c, b = 0.01, d = 0.005, t0){
  t_pic <- log((a * b) / (c * d)) / (b + d)
  Age_pic <- t_pic + t0
  tibble(t_pic = t_pic, Age_pic = Age_pic)
}
```

## Age au pic par discipline

```{r}
# Effets fixes
fe_disc <- fixef(modele_disc)

# Intercept
a0 <- fe_disc["a.(Intercept)"]
c0 <- fe_disc["c.(Intercept)"]

# Effets discipline
disc_levels <- levels(df_disc$disc_factor)

age_pic_disc <- map_dfr(disc_levels, function(disc){

  a_disc <- a0 + fe_disc[paste0("a.disc_factor", disc)]
  c_disc <- c0 + fe_disc[paste0("c.disc_factor", disc)]

  compute_age_pic(a_disc, c_disc, t0 = t0) %>%
    mutate(discipline = disc)
})

age_pic_disc
```

## Age au pic par sexe

```{r}
fe_sex <- fixef(modele_sex)

a0 <- fe_sex["a.(Intercept)"]
c0 <- fe_sex["c.(Intercept)"]

sex_levels <- levels(df_sex$sex_factor)

age_pic_sex <- map_dfr(sex_levels, function(sex){

  a_sex <- a0 + fe_sex[paste0("a.sex_factor", sex)]
  c_sex <- c0 + fe_sex[paste0("c.sex_factor", sex)]

  compute_age_pic(a_sex, c_sex, t0 = t0) %>%
    mutate(sex = sex)
})

age_pic_sex
```

## Age au pic par athlete x discipline

```{r}
# Fonction âge au pic
compute_age_pic <- function(a, c) {
  ifelse(a <= 0 | c <= 0, NA, log((2 * a) / c) / 0.015)
}

# 1️⃣ Effets fixes
fe_disc <- fixef(modele_ath_disc)
a0 <- fe_disc["a.(Intercept)"]
c0 <- fe_disc["c.(Intercept)"]

# 2️⃣ Dataframe complet ID × discipline
df_ids <- df_ath_disc %>%
  select(ID, disc_factor) %>%
  distinct()

# 3️⃣ Effets aléatoires
re_disc <- ranef(modele_ath_disc)$`ID/disc_factor`

if(is.null(re_disc) || nrow(as.data.frame(re_disc)) == 0){
  # Pas d'effet aléatoire, créer une colonne a = 0
  re_disc_df <- df_ids %>% mutate(a = 0)
} else {
  re_disc_df <- as.data.frame(re_disc) %>%
    tibble::rownames_to_column("ID_disc") %>%
    separate(ID_disc, into = c("ID", "disc_factor"), sep = "/") %>%
    mutate(a = ifelse("a" %in% names(.), .[["a"]], 0)) %>%
    select(ID, disc_factor, a)
}

# 4️⃣ Calcul âge au pic
df_age_pic_ind <- df_ids %>%
  left_join(re_disc_df, by = c("ID", "disc_factor")) %>%
  rowwise() %>%
  mutate(
    a_ind = a0 + ifelse(paste0("a.disc_factor", disc_factor) %in% names(fe_disc),
                        fe_disc[paste0("a.disc_factor", disc_factor)], 0) + a,
    c_ind = c0 + ifelse(paste0("c.disc_factor", disc_factor) %in% names(fe_disc),
                        fe_disc[paste0("c.disc_factor", disc_factor)], 0),
    age_pic = compute_age_pic(a_ind, c_ind)
  ) %>%
  ungroup() %>%
  select(ID, disc_factor, age_pic)

df_age_pic_ind <- df_age_pic_ind %>%
  left_join(df_ath_disc %>% select(ID, Nom) %>% distinct(), by = "ID") %>%
  select(ID, Nom, disc_factor, age_pic)

df_age_pic_ind <- df_age_pic_ind %>%
  mutate(age_pic_real = age_pic + t0)  # âge réel

df_age_pic_ind
```


