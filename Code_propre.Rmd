---
title: "Code_propre"
author: "Arthur Deletang"
date: "2026-01-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)
```

## R Markdown

```{r}
load("data/fiche_wa.rdata")
summary(fiche_wa)
```

```{r}
# --- PARAMÈTRES ---
seuil_retraite <- 2022 # Si pas de perf après 2022, on considère la carrière finie

# --- NETTOYAGE INITIAL ET CALCUL DE L'ÂGE ---
# On crée une base de travail propre sans toucher à l'originale
df_travail <- fiche_wa %>%
  filter(!is.na(mark_numeric), !is.na(season), !is.na(Group_Discipline)) %>%
  mutate(
    season_num = as.numeric(as.character(season)),
    dob_parsed = parse_date_time(DOB, orders = c("ymd", "dmy", "mdy")),
    Age = season_num - year(dob_parsed)
  ) 

# --- FILTRE CARRIÈRES TERMINÉES ---
# On identifie ceux qui ont concouru après 2022
ids_actifs <- df_travail %>%
  filter(season_num > seuil_retraite) %>%
  pull(ID) %>%
  unique()

# On exclut ces IDs pour ne garder que les retraités
df_retraites <- df_travail %>%
  filter(!ID %in% ids_actifs)

# --- GESTION DES DOUBLONS ET SÉLECTION DE LA MEILLEURE PERF ---
# Une seule ligne par Athlète, par Âge et par Discipline
df_final <- df_retraites %>%
  # Supprime les doublons techniques (même perf dans l'année)
  distinct(ID, season, mark_numeric, discipline, .keep_all = TRUE) %>%
  
  # Groupement par athlète, âge et discipline
  group_by(ID, Age, discipline) %>%
  
  # On garde la meilleure performance annuelle (le max de mark_numeric)
  # Rappel : mark_numeric est négatif pour les courses, donc le max est le meilleur temps
  slice_max(mark_numeric, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  
  # --- ORGANISATION PAR FAMILLES ---
  # On simplifie les noms des groupes de discipline
  mutate(Famille = case_when(
    Group_Discipline == "sprints" ~ "Sprint",
    Group_Discipline == "throws"  ~ "Lancers",
    Group_Discipline %in% c("middlelong", "road-running") ~ "Endurance",
    TRUE ~ "A exclure"
  )) %>%
  # On ne garde que les 3 groupes d'intérêt pour le rapport
  filter(Famille != "A exclure")

# --- VÉRIFICATION ---
cat("Statistiques de la base nettoyée :\n")
cat("- Nombre d'athlètes retraités : ", length(unique(df_final$ID)), "\n")
cat("- Nombre total de lignes (1 par athlète/âge) : ", nrow(df_final), "\n")

# Petit aperçu rapide de la répartition
table(df_final$Famille, df_final$Sex)
rm(df_retraites)
rm(df_travail)
```

```{r}
# Extraction du pic réel par athlète et par discipline
stats_pic_discipline <- df_final %>%
  group_by(ID, Nom, Famille, discipline, Sex) %>%
  summarise(
    Age_Pic_Obs = Age[which.max(mark_numeric)],
    Best_Mark = max(mark_numeric),
    # On compte les années où l'athlète a pratiqué CETTE discipline précise
    Nb_Annees_Discipline = n_distinct(season_num),
    .groups = "drop"
  ) %>%
  # Filtre : au moins 5 ans de pratique dans la discipline
  filter(Nb_Annees_Discipline >= 5)

# Aperçu du résultat
head(stats_pic_discipline)
```


```{r}
# Résumé statistique par Famille
desc_famille <- stats_pic_discipline %>%
  group_by(Famille) %>%
  summarise(
    Effectif = n(),
    Moyenne = mean(Age_Pic_Obs),
    Mediane = median(Age_Pic_Obs),
    SD = sd(Age_Pic_Obs),
    Max_Age = max(Age_Pic_Obs)
  )

print(desc_famille)

# Graphique : Boxplot par Famille
p1 <- ggplot(stats_pic_discipline, aes(x = Famille, y = Age_Pic_Obs, fill = Famille)) +
  geom_boxplot(notch = TRUE, alpha = 0.7) +
  labs(title = "Comparaison de l'âge au pic par famille de discipline",
       subtitle = "Carrières terminées (>= 5 ans d'expérience)",
       y = "Âge au pic (Années)", x = "") +
  theme_minimal()

print(p1)

# Par discipline
p2 <- ggplot(stats_pic_discipline, aes(x = Famille, y = Age_Pic_Obs, fill = discipline)) +
  geom_boxplot(notch = TRUE, alpha = 0.7) +
  labs(title = "Comparaison de l'âge au pic par discipline",
       subtitle = "Carrières terminées (>= 5 ans d'expérience)",
       y = "Âge au pic (Années)", x = "") +
  theme_minimal()

print(p2)
```

```{r}
# 1. Préparation des données pour TOUTES les disciplines
stats_toutes_disc <- stats_pic_discipline %>%
  group_by(Famille, discipline) %>%
  summarise(
    Moyenne_Pic = mean(Age_Pic_Obs),
    Effectif = n(),
    .groups = "drop"
  ) %>%
  filter(Effectif >= 5) %>% # On garde un minimum de 5 athlètes pour que la barre ait du sens
  arrange(Moyenne_Pic)

# 2. Graphique complet
ggplot(stats_toutes_disc, aes(x = reorder(discipline, Moyenne_Pic), y = Moyenne_Pic, fill = Famille)) +
  geom_col(alpha = 0.8) +
  # Ajout de la valeur précise au bout de chaque barre
  geom_text(aes(label = round(Moyenne_Pic, 1)), hjust = -0.2, size = 3) +
  coord_flip(ylim = c(15, max(stats_toutes_disc$Moyenne_Pic) + 3)) +
  scale_fill_brewer(palette = "Set1") +
  labs(
    title = "Âge moyen au pic par discipline",
    x = "Discipline",
    y = "Âge moyen au pic observé",
    fill = "Famille"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 8),
    legend.position = "bottom"
  )
```

#séparation H/F
```{r}
# 1. Préparation des données (on s'assure d'avoir les deux sexes pour chaque discipline)
stats_comp_sex <- stats_pic_discipline %>%
  group_by(discipline, Sex, Famille) %>%
  summarise(
    Moyenne_Pic = mean(Age_Pic_Obs),
    Effectif = n(),
    .groups = "drop"
  ) 

# 2. Graphique avec barres juxtaposées (position dodge)
age_pic_réel <- ggplot(stats_comp_sex, aes(x = discipline, y = Moyenne_Pic, fill = Sex)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  # Ajout des étiquettes (on les décale aussi avec position_dodge)
  geom_text(aes(label = round(Moyenne_Pic, 1)), 
            position = position_dodge(width = 0.8), 
            hjust = -0.2, size = 2.8) +
  coord_flip(ylim = c(15, max(stats_comp_sex$Moyenne_Pic) + 5)) +
  # Couleurs contrastées pour H/F
  scale_fill_manual(values = c("men" = "#377EB8", "women" = "#FB9A99")) +
  labs(
    title = "Comparaison de l'âge au pic : Hommes vs Femmes",
    subtitle = "Moyenne observée par discipline (Carrières >= 5 ans)",
    x = "Discipline",
    y = "Âge moyen au pic",
    fill = "Sexe"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 9),
    legend.position = "top"
  )
age_pic_réel
```


```{r}
# 1. Déséquilibre hommme-femme 

df_final %>%
  count(Sex) %>%
  mutate(pourcentage = n / sum(n) * 100)

df_final %>%
  count(season, Sex) %>%
  group_by(season) %>%
  mutate(pourcentage = n / sum(n) * 100) %>% 
  print(n = 70)

# Déséquilibre homme-femme par saison 

ggplot(df_final, aes(x = season, fill = Sex)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Répartition des athlètes par saison et par sexe",
    x = "Saison",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Déséquilibre homme-femme par discipline

epreuve_sexe <- df_final %>%
  count(Epreuve_championnat, Sex)

ggplot(epreuve_sexe, aes(x = Epreuve_championnat, y = n, fill = Sex)) +
  geom_col(position = "dodge") +
  labs(
    title = "Répartition des athlètes par Epreuve_championnat et par sexe",
    x = "Epreuve_championnat",
    y = "Nombre d’athlètes"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 2. Répartition par discipline 

df_final %>%
  distinct(ID, discipline, Sex) %>%
  count(discipline, Sex) %>%
  group_by(discipline) %>% 
  mutate(pourcentage = n / sum(n) * 100) %>%
  arrange(desc(pourcentage))
```

```{r}
# FOCUS SUR L'AGE EN GENERAL

# 1. Stats des sur l'âge

age_min <- min(df_final$Age, na.rm = TRUE)
age_max <- max(df_final$Age, na.rm = TRUE)
age_moyen <- mean(df_final$Age, na.rm = TRUE)
age_mediane <- median(df_final$Age, na.rm = TRUE)

age_min
age_max
age_moyen
age_mediane

age_ecart_type <- sd(df_final$Age, na.rm = TRUE)
age_ecart_type

quartiles_age <- quantile(df_final$Age, probs = c(0.25, 0.75), na.rm = TRUE)
quartiles_age

# 2. Déséquilibre âge (distribution)

df_final %>%
  count(Age) %>%
  mutate(pourcentage = n / sum(n) * 100)

df_final <- df_final %>%
  mutate(tranche_age = cut(Age,
                            breaks = c(15, 20, 25, 30, 35, Inf),
                            right = FALSE,
                            labels = c("15-20", "20-25", "25-30", "30-35", ">35")))

distribution_age <- df_final %>%
  count(tranche_age)

distribution_age

# Visuellement 

ggplot(df_final, aes(x = Age)) +
  geom_histogram(aes(y = after_stat(density)),
                 binwidth = 2,
                 fill = "grey80",
                 color = "white") +
  geom_density(color = "steelblue", linewidth = 1) +
  labs(title = "Distribution et densité de l'âge",
       x = "Âge",
       y = "Densité") +
  theme_minimal()


```

```{r}
# On étudie en détal mark_numeric 

stats_performance <- df_final %>%
  group_by(discipline) %>%
  summarise(
    n = n(),
    min = min(mark_numeric, na.rm = TRUE),
    Q1 = quantile(mark_numeric, 0.25, na.rm = TRUE),
    mediane = median(mark_numeric, na.rm = TRUE),
    moyenne = mean(mark_numeric, na.rm = TRUE),
    Q3 = quantile(mark_numeric, 0.75, na.rm = TRUE),
    max = max(mark_numeric, na.rm = TRUE),
    ecart_type = sd(mark_numeric, na.rm = TRUE)
  ) %>%
  arrange(discipline)

stats_performance

# On corrige les performances négatives pour les disciplines de sprint et d'endurance 

df_final <- df_final %>%
  mutate(mark_numeric_corrigee = ifelse(Famille %in% c("Sprint", "Endurance"),
                                       -mark_numeric,
                                       mark_numeric))

stats_performance_corrigee <- df_final %>%
  group_by(discipline) %>%
  summarise(
    n = n(),
    min = min(mark_numeric_corrigee, na.rm = TRUE),
    Q1 = quantile(mark_numeric_corrigee, 0.25, na.rm = TRUE),
    mediane = median(mark_numeric_corrigee, na.rm = TRUE),
    moyenne = mean(mark_numeric_corrigee, na.rm = TRUE),
    Q3 = quantile(mark_numeric_corrigee, 0.75, na.rm = TRUE),
    max = max(mark_numeric_corrigee, na.rm = TRUE),
    ecart_type = sd(mark_numeric_corrigee, na.rm = TRUE)
  ) %>%
  arrange(discipline)

stats_performance_corrigee

# On centre et on réduit cette valeur corrigée (conseiller pour les modèles non linéaires)

df_final <- df_final %>%
  group_by(discipline) %>%
  mutate(mark_numeric_centree_reduite = as.numeric(scale(mark_numeric_corrigee))) %>%
  ungroup()


```

```{r}
# Modèle de Moore (pour chaque discipline (Famille dans un premier temps))

# Pour chaque discipline

resultats_discipline <- df_final %>%
  group_by(discipline) %>%
  do({
    modele <- lm(mark_numeric_corrigee ~ Age + I(Age^2), data = .)
    coefs <- coef(modele)
    age_pic <- -coefs["Age"] / (2 * coefs["I(Age^2)"])
    
    data.frame(
      discipline = unique(.$discipline),
      age_pic = age_pic,
      r_squared = summary(modele)$r.squared,
      aic = AIC(modele),
      bic = BIC(modele)
    )
  })

resultats_discipline

# Pour chaque sexe et discipline 

resultats_sexe_discipline <- df_final %>%
  group_by(Sex, discipline) %>%
  do({
    modele <- lm(mark_numeric_corrigee ~ Age + I(Age^2), data = .)
    coefs <- coef(modele)
    age_pic <- -coefs["Age"] / (2 * coefs["I(Age^2)"])
    
    data.frame(
      sexe_discipline = unique(.$Sex, .$discipline),
      age_pic = age_pic,
      r_squared = summary(modele)$r.squared,
      aic = AIC(modele),
      bic = BIC(modele)
    )
  })

resultats_sexe_discipline

#graph 
# Utilisation de ton objet resultats_sexe_discipline
ggplot(resultats_sexe_discipline, aes(x = discipline, y = age_pic, fill = Sex)) +
  # Barres côte à côte pour comparer Hommes et Femmes
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  
  # Ajout des valeurs au bout des barres
  geom_text(aes(label = round(age_pic, 1)), 
            position = position_dodge(width = 0.8), 
            hjust = -0.2, size = 3) +
  
  # Inversion des axes pour la lisibilité
  coord_flip() +
  
  # Couleurs pour le Sexe
  scale_fill_manual(values = c("men" = "#377EB8", "women" = "#FB9A99")) +
  
  labs(
    title = "Âge au Pic Théorique par Discipline (Modèle de Moore)",
    x = "Discipline",
    y = "Âge au pic calculé",
    fill = "Sexe"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 9),
    legend.position = "top"
  )

print(age_pic_réel)
```



